<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Get Started: Methods to address batch effects • batchtma</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Get Started: Methods to address batch effects">
<meta property="og:description" content="batchtma">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">batchtma</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/batchtma.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/stopsack/batchtma/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="batchtma_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Get Started: Methods to address batch effects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/stopsack/batchtma/blob/master/vignettes/batchtma.Rmd" class="external-link"><code>vignettes/batchtma.Rmd</code></a></small>
      <div class="hidden name"><code>batchtma.Rmd</code></div>

    </div>

    
    
<div id="installation" class="section level1">
<h1 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h1>
<p>Currently, the development version of batchtma can be installed from <a href="https://github.com/" class="external-link">GitHub</a> using:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("remotes")  # The "remotes" package needs to be installed</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://remotes.r-lib.org" class="external-link">remotes</a></span><span class="op">)</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"stopsack/batchtma"</span><span class="op">)</span></code></pre></div>
<p>To have vignettes like this current site be available offline via, <em>e.g.</em>, <code><a href="../articles/batchtma.html">vignette("batchtma")</a></code>, modify the last commend:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"stopsack/batchtma"</span>, build_vignettes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="set-up-and-plot-example-data" class="section level1">
<h1 class="hasAnchor">
<a href="#set-up-and-plot-example-data" class="anchor"></a>Set up and plot example data</h1>
<p>We load the batchtma package and, for convenience with data handling and plotting, the tidyverse package:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stopsack.github.io/batchtma">batchtma</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></code></pre></div>
<p>We construct a toy dataset of 10 individuals (<em>e.g.,</em> tumors), each with 40 measurements (<em>e.g.,</em> cores on tissue microarrays) per batch. Unlike perhaps in the real world, for each individual tumor, we also have measurements on all the other batches.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>  <span class="co"># for reproducibility</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>
  <span class="co"># Batches:</span>
  batch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"batch"</span>, <span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,
  batchnum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,
  <span class="co"># Participants:</span>
  person <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, each <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>,
  <span class="co"># Instead of a confounder, we will use a random variable for now:</span>
  random <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">400</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">2</span>, max <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,
  <span class="co"># The true (usually unobservable biomarker value):</span>
  true <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2.5</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">8</span>, <span class="fl">10</span>, <span class="fl">12</span>, <span class="fl">15</span>, <span class="fl">12</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>,
  <span class="co"># The observed biomarker value with random error ("noise"):</span>
  noisy <span class="op">=</span> <span class="va">true</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span>max <span class="op">=</span> <span class="va">true</span> <span class="op">/</span> <span class="fl">3</span>, n <span class="op">=</span> <span class="fl">400</span><span class="op">)</span> <span class="op">*</span> <span class="fl">4</span><span class="op">)</span>

<span class="va">df</span>
<span class="co">#&gt; # A tibble: 400 x 6</span>
<span class="co">#&gt;    batch  batchnum person random  true noisy</span>
<span class="co">#&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1 batchA        1 a      -0.850     2  4.63</span>
<span class="co">#&gt;  2 batchB        5 a       1.15      2  2.37</span>
<span class="co">#&gt;  3 batchC        2 a      -0.364     2  4.41</span>
<span class="co">#&gt;  4 batchD        3 a       1.53      2  3.54</span>
<span class="co">#&gt;  5 batchA        1 a       1.76      2  3.05</span>
<span class="co">#&gt;  6 batchB        5 a      -1.82      2  3.20</span>
<span class="co">#&gt;  7 batchC        2 a       0.112     2  3.88</span>
<span class="co">#&gt;  8 batchD        3 a       1.57      2  2.22</span>
<span class="co">#&gt;  9 batchA        1 a       0.206     2  2.90</span>
<span class="co">#&gt; 10 batchB        5 a      -0.174     2  3.82</span>
<span class="co">#&gt; # … with 390 more rows</span></code></pre></div>
<p>We plot the biomarker values (<em>y</em>-axis) by batch (<em>x</em>-axis), using the <code><a href="../reference/plot_batch.html">plot_batch()</a></code> function. Color/shape symbolizes which participant/tumor the measurements came from. Boxes span from the 25th to the 75th percentile (interquartile range); thick lines indicate medians; asterisks indicate means.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">person</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div id="add-batch-effects" class="section level2">
<h2 class="hasAnchor">
<a href="#add-batch-effects" class="anchor"></a>Add batch effects</h2>
<p>We add systematic differences between batches such that there is differential measurement error between batches in terms of mean and variance. As shown above, true values were the same beyond random error.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span>
  <span class="co"># Multiply by batch number to differentially change variance by batch,</span>
  <span class="co"># divide by mean batch number to keep overall variance the same:</span>
  <span class="fu">mutate</span><span class="op">(</span>noisy_batch <span class="op">=</span> <span class="va">noisy</span> <span class="op">*</span> <span class="va">batchnum</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">batchnum</span><span class="op">)</span> <span class="op">+</span> 
           <span class="co"># Similarly, change mean value per batch, keeping overall mean the same:</span>
           <span class="va">batchnum</span> <span class="op">*</span> <span class="fl">3</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">batchnum</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span>

<span class="va">df</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">person</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
</div>
<div id="perform-batch-effect-adjustment-without-confounders" class="section level1">
<h1 class="hasAnchor">
<a href="#perform-batch-effect-adjustment-without-confounders" class="anchor"></a>Perform batch effect adjustment without confounders</h1>
<div id="simple-means" class="section level2">
<h2 class="hasAnchor">
<a href="#simple-means" class="anchor"></a>Simple means</h2>
<p><code>method = simple</code> calculates the mean for each batch and subtracts the difference between this mean and the grand mean, such that all batches end up having a mean equivalent to the grand mean. Differences in variance between batches will remain, if they exist (as in this example).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/adjust_batch.html">adjust_batch</a></span><span class="op">(</span>markers <span class="op">=</span> <span class="va">noisy_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, 
               method <span class="op">=</span> <span class="va">simple</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_batch_adj2</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">person</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
<div id="means-from-marginal-standardization" class="section level2">
<h2 class="hasAnchor">
<a href="#means-from-marginal-standardization" class="anchor"></a>Means from marginal standardization</h2>
<p><code>method = standardize</code> performs marginal standardization by fitting a linear regression model for biomarker values with <code>batch</code> and <code>confounders</code> as predictors, and obtains the marginal means per batch if they had the same distribution of <code>confounders</code>. Differences between these marginal means and the grand mean are subtracted as in <code>method = simple</code>. In this example, the confounder is a random variable, and the results are essentially the same as for <code>method = simple</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/adjust_batch.html">adjust_batch</a></span><span class="op">(</span>markers <span class="op">=</span> <span class="va">noisy_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, 
               method <span class="op">=</span> <span class="va">standardize</span>, confounders <span class="op">=</span> <span class="va">random</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_batch_adj3</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">person</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div id="inverse-probability-weighting" class="section level2">
<h2 class="hasAnchor">
<a href="#inverse-probability-weighting" class="anchor"></a>Inverse-probability weighting</h2>
<p><code>method = ipw</code> predicts the probability of a measurement being from a specific batch, given the <code>confounders</code>. Mean differences between batches are obtained from a marginal structural model with stabilized inverse-probability weights and then used as in the two preceding methods. Again, the confounder is merely a random variable in this example.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/adjust_batch.html">adjust_batch</a></span><span class="op">(</span>markers <span class="op">=</span> <span class="va">noisy_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, 
               method <span class="op">=</span> <span class="va">ipw</span>, confounders <span class="op">=</span> <span class="va">random</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_batch_adj4</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">person</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
<div id="quantile-regression" class="section level2">
<h2 class="hasAnchor">
<a href="#quantile-regression" class="anchor"></a>Quantile regression</h2>
<p><code>method = quantreg</code>, unlike the three preceding mean-only methods, addresses two distinct properties of batches: the “offset” values (a lower quantile), potentially reflective of background signal, and an inter-quantile range, potentially reflective of the “dynamic range” of the measurement. By default, the first and third qua<strong>r</strong>tile are used.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/adjust_batch.html">adjust_batch</a></span><span class="op">(</span>markers <span class="op">=</span> <span class="va">noisy_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, 
               method <span class="op">=</span> <span class="va">quantreg</span>, confounders <span class="op">=</span> <span class="va">random</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_batch_adj5</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">person</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
<div id="quantile-normalization" class="section level2">
<h2 class="hasAnchor">
<a href="#quantile-normalization" class="anchor"></a>Quantile normalization</h2>
<p><code>method = quantnorm</code> performs quantile normalization: values are ranked within each batch, and then each rank is assigned the mean per rank across batches. Quantile normalization ensures that all batches have near-identical biomarker distributions. However, quantile normalization does not allow for accounting for <code>confounders</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/adjust_batch.html">adjust_batch</a></span><span class="op">(</span>markers <span class="op">=</span> <span class="va">noisy_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, 
               method <span class="op">=</span> <span class="va">quantnorm</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_batch_adj6</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">person</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
</div>
<div id="perform-batch-effect-adjustment-in-the-presence-of-confounding" class="section level1">
<h1 class="hasAnchor">
<a href="#perform-batch-effect-adjustment-in-the-presence-of-confounding" class="anchor"></a>Perform batch effect adjustment in the presence of confounding</h1>
<div id="set-up-example-data-with-confounding-present" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up-example-data-with-confounding-present" class="anchor"></a>Set up example data with confounding present</h2>
<p>In general, confounding means that exposure and outcome share common causes. Necessary—but not sufficient—properties of a confounder are that it needs to be associated with the exposure (<code>batch</code>) and associated with the outcome(s) (<code>markers</code>). For example, if systematically higher biomarker values due to batch effects happen to occur in a tissue microarray with a higher proportion of aggressive tumors, then batch effect-adjusted biomarker values should account for the differences in proportions of aggressive tumors.</p>
<p>In the example, a new variable for the biomarker is generated that is affected by both confounding and batch effects. First, biomarker values with random error, <code>noisy</code>, are forced to be associated with the <code>confounder</code>, which in turn is associated with <code>batch</code>. These values, <code>noisy_conf</code>, should be considered the new “ground truth.”</p>
<p>All following plots show color/symbol shape by <code>confounder</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>  <span class="co"># for reproducibility</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span>
  <span class="co"># Make confounder associated with batch:</span>
  <span class="fu">mutate</span><span class="op">(</span>confounder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">batchnum</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">200</span>, max <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
         <span class="co"># Make biomarker values associated with confounder:</span>
         noisy_conf <span class="op">=</span> <span class="va">noisy</span> <span class="op">+</span> <span class="va">confounder</span> <span class="op">*</span> <span class="fl">3</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">confounder</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span>

<span class="va">df</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_conf</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>Second, batch effects for mean and variance are added.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="co"># Add batch effects to confounded biomarker values:</span>
  <span class="fu">mutate</span><span class="op">(</span>noisy_conf_batch <span class="op">=</span> <span class="va">noisy_conf</span> <span class="op">*</span> <span class="va">batchnum</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">batchnum</span><span class="op">)</span> <span class="op">+</span> 
           <span class="va">batchnum</span> <span class="op">*</span> <span class="fl">3</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">batchnum</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span>

<span class="va">df</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_conf_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>The following examples show to what extent batch effects can be removed from <code>noisy_conf_batch</code> to recover the “ground truth,” <code>noisy_conf</code>.</p>
</div>
<div id="means-from-marginal-standardization-1" class="section level2">
<h2 class="hasAnchor">
<a href="#means-from-marginal-standardization-1" class="anchor"></a>Means from marginal standardization</h2>
<p><code>method = standardize</code> reduces batch effects while allowing batch means to differ because of the confounder. Batches with higher “true” biomarker values associated with the confounder, like batch B, retain higher means after batch effect adjustment.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/adjust_batch.html">adjust_batch</a></span><span class="op">(</span>markers <span class="op">=</span> <span class="va">noisy_conf_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, 
               method <span class="op">=</span> <span class="va">standardize</span>, confounders <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_conf_batch_adj3</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
</div>
<div id="inverse-probability-weighting-1" class="section level2">
<h2 class="hasAnchor">
<a href="#inverse-probability-weighting-1" class="anchor"></a>Inverse-probability weighting</h2>
<p><code>method = ipw</code> also reduces batch effects while allowing batch means to differ because of the confounder. As with marginal standardization, differences in variance between batches are not addressed.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/adjust_batch.html">adjust_batch</a></span><span class="op">(</span>markers <span class="op">=</span> <span class="va">noisy_conf_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, 
               method <span class="op">=</span> <span class="va">ipw</span>, confounders <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_conf_batch_adj4</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
</div>
<div id="quantile-regression-1" class="section level2">
<h2 class="hasAnchor">
<a href="#quantile-regression-1" class="anchor"></a>Quantile regression</h2>
<p><code>method = quantreg</code> reduces for batch effects of “offset” and “dynamic range” separately, accounting for differences in confounders. In the example, batch B with its high levels of the confounder retains somewhat higher values and a higher variance, unlike with the two preceding mean-only methods.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/adjust_batch.html">adjust_batch</a></span><span class="op">(</span>markers <span class="op">=</span> <span class="va">noisy_conf_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, 
               method <span class="op">=</span> <span class="va">quantreg</span>, confounders <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_conf_batch_adj5</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
<div id="for-comparison-batch-effect-adjustment-ignoring-confounding" class="section level2">
<h2 class="hasAnchor">
<a href="#for-comparison-batch-effect-adjustment-ignoring-confounding" class="anchor"></a>For comparison: Batch effect adjustment ignoring confounding</h2>
<div id="simple-means-1" class="section level3">
<h3 class="hasAnchor">
<a href="#simple-means-1" class="anchor"></a>Simple means</h3>
<p><code>method = simple</code> leads to all batches having the same mean after adjustment. In the example, this method ignores that batch B should have higher values because of higher values of the confounder.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/adjust_batch.html">adjust_batch</a></span><span class="op">(</span>markers <span class="op">=</span> <span class="va">noisy_conf_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, 
               method <span class="op">=</span> <span class="va">simple</span>, confounders <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_conf_batch_adj2</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span>
<span class="co">#&gt; Batch effect correction via 'method = simple' was requested.</span>
<span class="co">#&gt;  This method does not support adjustment for confounders (confounder). They will be ignored.</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
</div>
<div id="quantile-regression-2" class="section level3">
<h3 class="hasAnchor">
<a href="#quantile-regression-2" class="anchor"></a>Quantile regression</h3>
<p><code>method = quantreg</code> also ignores the confounder.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/adjust_batch.html">adjust_batch</a></span><span class="op">(</span>markers <span class="op">=</span> <span class="va">noisy_conf_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, 
               method <span class="op">=</span> <span class="va">quantnorm</span>, confounders <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/plot_batch.html">plot_batch</a></span><span class="op">(</span>marker <span class="op">=</span> <span class="va">noisy_conf_batch_adj6</span>, batch <span class="op">=</span> <span class="va">batch</span>, color <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span>
<span class="co">#&gt; Batch effect correction via 'method = quantnorm' was requested.</span>
<span class="co">#&gt;  This method does not support adjustment for confounders (confounder). They will be ignored.</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
</div>
</div>
</div>
<div id="additional-features" class="section level1">
<h1 class="hasAnchor">
<a href="#additional-features" class="anchor"></a>Additional features</h1>
<div id="missing-values" class="section level2">
<h2 class="hasAnchor">
<a href="#missing-values" class="anchor"></a>Missing values</h2>
<p>batchtma can handle missing biomarker values, which is a common phenomenon in tissue microarray studies. This situation is different from gene expression studies, where measured genes are typically measured on all batches (<em>e.g.</em>, microarrays). No coding changes are needed. If multiple biomarkers are batch-adjusted with one call of <code><a href="../reference/adjust_batch.html">adjust_batch(markers = c(biomarker_a, biomarker_b, biomarker_c), ...)</a></code> and different rows (e.g., tumors) have missing values for different columns (biomarkers), no values will be excluded because of missingness in another marker.</p>
</div>
<div id="model-diagnostics" class="section level2">
<h2 class="hasAnchor">
<a href="#model-diagnostics" class="anchor"></a>Model diagnostics</h2>
<p>When running <code><a href="../reference/adjust_batch.html">adjust_batch()</a></code>, the dataset is returned with the batch effect-adjusted variables added at the end. Yet what did <code><a href="../reference/adjust_batch.html">adjust_batch()</a></code> do and how well did the methods used for batch effect correction fit to the data that they were applied to? Adjustment for batch effects relies on regression models for methods <code>standardize</code>, <code>ipw</code>, and <code>quantreg</code>; in addition, <code>method = simple</code> estimates means per batch.</p>
<p>The <code><a href="../reference/diagnose_models.html">diagnose_models()</a></code> function provides an overview of what <code><a href="../reference/adjust_batch.html">adjust_batch()</a></code> did, shows overview of the adjustment models, and provides access to detailed model diagnostics.</p>
<p>To obtain an overview of model diagnostics, <code><a href="../reference/diagnose_models.html">diagnose_models()</a></code> is called on the return values of <code><a href="../reference/adjust_batch.html">adjust_batch()</a></code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># df2 is the new dataset that also contains "noisy_conf_batch_adj2":</span>
<span class="va">df2</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/adjust_batch.html">adjust_batch</a></span><span class="op">(</span>markers <span class="op">=</span> <span class="va">noisy_conf_batch</span>, batch <span class="op">=</span> <span class="va">batch</span>, 
                           method <span class="op">=</span> <span class="va">standardize</span>, confounders <span class="op">=</span> <span class="va">confounder</span><span class="op">)</span>

<span class="co"># Show overview of model diagnostics:</span>
<span class="fu"><a href="../reference/diagnose_models.html">diagnose_models</a></span><span class="op">(</span><span class="va">df2</span><span class="op">)</span>
<span class="co">#&gt; Dataset after batch effect adjustment using 'method = standardize'</span>
<span class="co">#&gt; Variable defining batches: batch</span>
<span class="co">#&gt; Adjusted variables: noisy_conf_batch_adj3</span>
<span class="co">#&gt; Confounders: confounder</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Estimated adjustment parameters:</span>
<span class="co">#&gt; # A tibble: 4 x 3</span>
<span class="co">#&gt;   marker           .batchvar batchmean</span>
<span class="co">#&gt;   &lt;chr&gt;            &lt;chr&gt;         &lt;dbl&gt;</span>
<span class="co">#&gt; 1 noisy_conf_batch batchA      -12.4  </span>
<span class="co">#&gt; 2 noisy_conf_batch batchB       20.6  </span>
<span class="co">#&gt; 3 noisy_conf_batch batchC       -7.51 </span>
<span class="co">#&gt; 4 noisy_conf_batch batchD       -0.683</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Models for adjustment:</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [[1]][[1]]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; stats::lm(formula = stats::as.formula(paste0("value ~ .batchvar +", </span>
<span class="co">#&gt;     paste(confounders, collapse = " + ", sep = " + "))), data = .x)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;     (Intercept)  .batchvarbatchB  .batchvarbatchC  .batchvarbatchD  </span>
<span class="co">#&gt;          -8.469           33.079            4.930           11.759  </span>
<span class="co">#&gt;      confounder  </span>
<span class="co">#&gt;           2.893</span></code></pre></div>
<p>In this example, <code>method = standardize</code> fits a linear regression model with batch and confounders as exposure and the unadjusted biomarker as the outcome. This model can be extracted directly from <code><a href="../reference/diagnose_models.html">diagnose_models()</a></code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/diagnose_models.html">diagnose_models</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df2</span><span class="op">)</span><span class="op">$</span><span class="va">model_fits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; stats::lm(formula = stats::as.formula(paste0("value ~ .batchvar +", </span>
<span class="co">#&gt;     paste(confounders, collapse = " + ", sep = " + "))), data = .x)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -20.634  -5.834  -0.714   4.626  42.827 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                 Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)      -8.4686     1.7092  -4.955 1.08e-06 ***</span>
<span class="co">#&gt; .batchvarbatchB  33.0786     2.9225  11.319  &lt; 2e-16 ***</span>
<span class="co">#&gt; .batchvarbatchC   4.9297     1.4606   3.375 0.000811 ***</span>
<span class="co">#&gt; .batchvarbatchD  11.7585     1.8269   6.436 3.55e-10 ***</span>
<span class="co">#&gt; confounder        2.8926     0.6837   4.231 2.90e-05 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 9.275 on 395 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.7684, Adjusted R-squared:  0.7661 </span>
<span class="co">#&gt; F-statistic: 327.7 on 4 and 395 DF,  p-value: &lt; 2.2e-16</span></code></pre></div>
<p>The marginally standardized means per batch are the adjustment parameters estimates by this procedure. They are returned by <code><a href="../reference/diagnose_models.html">diagnose_models()</a></code> as <code>adjust_parameters</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/diagnose_models.html">diagnose_models</a></span><span class="op">(</span><span class="va">df2</span><span class="op">)</span><span class="op">$</span><span class="va">adjust_parameters</span>
<span class="co">#&gt; # A tibble: 4 x 3</span>
<span class="co">#&gt;   marker           .batchvar batchmean</span>
<span class="co">#&gt;   &lt;chr&gt;            &lt;chr&gt;         &lt;dbl&gt;</span>
<span class="co">#&gt; 1 noisy_conf_batch batchA      -12.4  </span>
<span class="co">#&gt; 2 noisy_conf_batch batchB       20.6  </span>
<span class="co">#&gt; 3 noisy_conf_batch batchC       -7.51 </span>
<span class="co">#&gt; 4 noisy_conf_batch batchD       -0.683</span></code></pre></div>
<p>Diagnostics for regresion models can be performed on fitted models just as for any other regression model in R. For example, residuals <em>vs.</em> fitted can be plotted:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>fitted    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted.values</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>,
       residuals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">fitted</span>, y <span class="op">=</span> <span class="va">residuals</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="batchtma_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Konrad Stopsack.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
